# Meteor. Разрабатываем TODO List.

В данном уроке я не хочу обсуждать, почему метеор убийца веба, тем более я так не считаю, но определенную симпатию к этому фреймворку имею. Поэтому хочу показать с чего можно начать при разработке приложения на нем, какие есть пакеты и вообще что есть такое этот метеор.

Сразу хочу сказать, что у меня нет большого опыта в разработке веб приложений. Я занимаюсь этим всего около двух лет, а с метеором знаком вообще лишь пару месяцев.

Также хочу предупредить, что в данном уроке будут использоваться
следующие технологии для непосредственного написания примера:

* `jade` - html препроцессор;
* `less` - css препроцессор;
* `coffeescript` - язык программирования, компилируемый в javascript.

Небольшая затравка в виде скриншота полученного в ходе урока

![result](https://raw.githubusercontent.com/ovcharik/meteor-getting-started/master/images/result.png)

И кому все еще интересно, добро пожаловать под кат.

+-------------+
| Продолжение |
+-------------+

## Установка Meteor

Сам метеор базируется на `nodejs` и `mongodb`, так же у метеора нет поддержки windows, но они обещают скорым временем это исправить.

Поэтому первым делом устанавливаем [nodejs](http://nodejs.org/download/) и [mongodb](http://www.mongodb.org/downloads).

Следующим шагом необходимо установить метеор. Он не лежит в npm репозитории, поэтому не нужно торопиться и командовать `npm install -g meteor`, в данном случае лишь загрузиться его старая версия, для правильно установки необходимо выполнить в консоли:

    $ curl https://install.meteor.com/ | sh

## Создание проекта

После установки метеора можно сходу командовать

    $ meteor create 'todo-list'
    todo-list: created.

    To run your new app:
       cd todo-list
       meteor
    $ cd todo-list
    $ meteor
    [[[[[ ~/dev/meteor-getting-started/todo-list ]]]]]

    => Started proxy.
    => Started MongoDB.
    => Started your app.

    => App running at: http://localhost:3000/

Данный вывод означает, что все прошло хорошо, и наш хелловорлд можно проверить в браузере.

![helloworld](https://raw.githubusercontent.com/ovcharik/meteor-getting-started/master/images/helloworld.png)


Теперь, после проверки работоспособности нового проекта, файлы, находящиеся в корне проекта, можно удалить, нам они не особо интересны. Также можно заметить что была создана директория `.meteor`, там хранится различная служебная информация о проекте и даже автоматически сгенерируемый `.gitignore`, кстати для ручного управления пакетами можно изменять файл `packages`, но консольные утилиты тоже достаточно удобны.

Если у вас такой же результат как и у меня, значит минимальное окружение для разработки метеор проекта готово, если же что-то пошло не так - проверьте корректность установки `nodejs`, `mongodb` и `meteor`, например, у меня на компьютере сейчас следующая конфигурация:

/*
    $ node -v
    v0.10.33
    $ mongod --version
    db version v2.4.12
    $ meteor --version
    Meteor 1.0
*/

На данном этапе мы закончим с формальностями и приступим к разработке нашего туду листа. Для удобства рекомендую открыть новую вкладку консоли, так как перезапускать наше метеор приложение больше не потребуется, но будем использовать консольный интерфейс фреймворка для установки пакетов.

## Пакеты

Тут я опять же не хочу обсуждать почему в метеоре используется свой пакетный менеджер и почему они любят так велосипедить, к уроку это никакого отношения не имеет.

Установка пакетов производится командой

    $ meteor add <package-name>

Как я писал выше, приложение будем разрабатывать на `less`, `jade` и `coffeescript`, а значит самое время установить их. Все пакеты, используемые в уроке, и кучу других можно найти на сайте [Atmosphere](https://atmospherejs.com/). Собственно названия пакетов:

* `less`, `coffeescript` - это официальные пакеты, поэтому не содержат имя автора;
* `mquandalle:jade` - а вот это не официальный пакет, поэтому название состоит из двух составляющих, но выполнен он хорошо, и никаких проблем при его использовании у меня не возникало.

По ходу разработки мы добавим еще несколько популярных пакетов, и я постараюсь описать назначения каждого. Кстати `jquery` и `underscore` уже включены в метеор, как и множество других пакетов, полный список установленных пакетов, можно посмотреть в файле `./.meteor/versions`, в новосозданном проекте.

## Структура приложения

Теперь, по-моему, самое время разобраться с тем как метеор подключает файлы в проект, и какие способы регуляции этого существуют. Здесь нам не потребуется писать конфигурационные файлы для `grant` или `gulp`, метеор уже позаботился об этом. Для скафолдинга существует [проект](https://github.com/Pent/generator-meteor) для Yeoman, но мне приятнее все создавать в ручную. В предыдущем проекте я использовал следующую структуру папок:

    todo-list/           - корень проекта
    ├── client           - тут будут чисто клиентские файлы
    │   ├── components   - компоненты приложения будут состоять из шаблона 
    │   │                  и скрипта, реализующего его логику
    │   ├── config       - файлы конфигурации
    │   ├── layouts      - базовые шаблоны, не имеющие никакой логики
    │   ├── lib          - различные скрипты, которые могут понадобится на
    │   │                  клиенте
    │   ├── routes       - клиентский роутинг
    │   └── styles       - стили
    ├── collections      - здесь будем хранить модели
    ├── lib              - скрипты, которые могут понадобится везде
    ├── public           - статика, картинки, robots.txt и все такое
    ├── server           - файлы для серверной части приложения
    │   ├── methods      - тут будут серверные методы, типа реста,
    │   │                  только удобнее
    │   ├── publications - расшаривание данных из коллекций
    │   ├── routes       - серверный роутинг, собственно можно будет
    │   │                  контролировать http запросы
    │   └── startup      - инициализация сервера

Но в метеоре нет никаких ограничений на именование папок и файлов, так что можете придумать, любую, удобную для вас структуру. Главное следует помнить о некоторых нюансах:

* все файлы из папки `public` в корне проекта будут доступны пользователям по ссылки из браузера;
* все файлы из папки `server` в корне, доступны только серверной части приложения;
* все файлы из папки `client` в корне, доступны только клиентской части приложения;
* все остальное, что находится в корне, доступно в любой среде;
* файлы в проект подключаются автоматически, по следующим правилам:
  - загрузка начинается с поддиректорий, и первой всегда обрабатывается директория с именем `lib`, далее все папки и файлы загружаются в алфавитном порядке;
  - файлы начинающиеся с `main.` загружаются последними.

Например рассмотрим, как будет загружаться наш проект в браузере: первым делом будут загружены файлы из директории `lib` в корне проекта, далее будет обрабатываться папка `client`, в ней также первым делом загрузятся файлы из `lib`, а потом в алфавитном порядке: `components` -> `config` -> ... -> `styles`. И уже после файлы из папки `collections`. Файлы из папок `public` и `server`, не будут загружены в браузер, но, например, скрипты, хранящиеся в папке `public`, можно подключить через тег `script`, как это мы привыкли делать в других проектах, однако разработчики фреймворка не рекомендуют подобный подход.

Также для регуляции среды выполнения в общих файлах можно воспользоваться следующими конструкциями:

```coffeescript
if Meteor.isClient
  # Код, выполняемый только в браузере
if Meteor.isServer
  # Код, выполняемый только на сервере
```

И для регулирования времени выполнения скриптов мы можем использовать метод `Meteor.startup(<func>)`, в браузере это аналог функции `$` из библиотеки `jQuery`, а на сервере, код в данной функции выполнится сразу же после загрузки всех скриптов. [Подробнее об этих переменных и методах](https://docs.meteor.com/#/full/core).
